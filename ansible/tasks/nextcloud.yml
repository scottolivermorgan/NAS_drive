# This playbook pulls the latest Nextcloud Docker image and runs a container using that image.

# Pull the latest nextcloud Docker image
- name: Pull Nextcloud Docker image
  community.docker.docker_image:
    name: nextcloud:latest
    source: pull

- name: Create directories
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /mnt/external/nextcloud
    - /mnt/external/apps
    - /mnt/external/config
    - /mnt/external/data
    - /mnt/external/theme

# Run the Nextcloud Docker container
- name: Run Nextcloud Docker container
  community.docker.docker_container:
    name: nextcloud
    image: nextcloud:latest
    state: started
    restart_policy: always  # Always restart the container if it stops
    published_ports:
      - "80:80"  # Port mapping (host_port:container_port)
    timeout: 240  # Timeout for starting the container (seconds)
    volumes:
      - "/mnt/external/nextcloud:/var/www/html"
      - "/mnt/external/apps:/var/www/html/custom_apps"
      - "/mnt/external/config:/var/www/html/config"
      #- "/mnt/external/data:/var/www/html/data" # TODO make scalable
      - "/mnt/external/theme:/var/www/html/themes"
      - "/media/HD_1:/var/www/html/data" 
